# Документация по защите маршрутов

## Обзор

Реализована качественная система защиты маршрутов, которая предотвращает доступ неавторизованных пользователей к защищенным страницам и автоматически перенаправляет авторизованных пользователей с публичных страниц.

## Архитектура защиты

### Типы маршрутов

1. **Защищенные маршруты** (`protected: true`)
   - Требуют авторизации
   - Автоматически перенаправляют на `/login` неавторизованных пользователей
   - Отображаются с Layout (шапка, сайдбар)

2. **Публичные маршруты** (`public: true`)
   - Доступны только неавторизованным пользователям
   - Автоматически перенаправляют авторизованных пользователей на главную страницу
   - Отображаются без Layout

3. **Обычные маршруты**
   - Доступны всем пользователям
   - Отображаются без Layout

## Компоненты защиты

### ProtectedRoute
```javascript
// Защищает маршруты от неавторизованных пользователей
<ProtectedRoute>
  <SomeProtectedComponent />
</ProtectedRoute>
```

**Функциональность:**
- Проверяет авторизацию пользователя
- Показывает AuthLoader во время проверки
- Перенаправляет на `/login` неавторизованных пользователей
- Сохраняет информацию о том, откуда пришел пользователь

### PublicRoute
```javascript
// Защищает публичные страницы от авторизованных пользователей
<PublicRoute>
  <LoginPage />
</PublicRoute>
```

**Функциональность:**
- Проверяет, что пользователь НЕ авторизован
- Перенаправляет авторизованных пользователей на главную страницу
- Показывает индикатор загрузки во время проверки

### AuthRedirectHandler
- Глобальный обработчик редиректов
- Автоматически перенаправляет неавторизованных пользователей с защищенных страниц
- Работает в фоновом режиме

## Конфигурация маршрутов

### routes.js
```javascript
export const routes = [
  {
    path: '/',
    element: <MainPage />,
    protected: true, // Защищенный маршрут
  },
  {
    path: '/login',
    element: <LoginPage />,
    public: true, // Публичный маршрут
  },
  {
    path: '/register',
    element: <RegisterPage />,
    public: true, // Публичный маршрут
  },
  {
    path: '/doctors',
    element: <DoctorsPage />,
    protected: true, // Защищенный маршрут
  },
];
```

## Логика редиректов

### Неавторизованный пользователь
1. Попытка доступа к защищенной странице → редирект на `/login`
2. После успешной авторизации → редирект на исходную страницу
3. Попытка доступа к несуществующей странице → редирект на `/login`

### Авторизованный пользователь
1. Попытка доступа к публичной странице → редирект на `/`
2. Попытка доступа к несуществующей странице → редирект на `/`

## Использование в компонентах

### Проверка авторизации
```javascript
import { useAuthContext } from '../features/auth/model/AuthContext';

const MyComponent = () => {
  const { isAuthenticated, user, loading } = useAuthContext();
  
  if (loading) return <div>Загрузка...</div>;
  
  return (
    <div>
      {isAuthenticated ? (
        <div>Добро пожаловать, {user?.first_name}!</div>
      ) : (
        <div>Пожалуйста, войдите в систему</div>
      )}
    </div>
  );
};
```

### Выход из системы
```javascript
import { useLogout } from '../features/auth/model/useLogout';

const LogoutButton = () => {
  const { logout, loading } = useLogout();
  
  return (
    <button onClick={logout} disabled={loading}>
      {loading ? 'Выход...' : 'Выйти'}
    </button>
  );
};
```

## Безопасность

### Защита от прямого доступа
- Все защищенные маршруты проверяют авторизацию
- Даже при прямом вводе URL неавторизованные пользователи перенаправляются

### Сохранение состояния
- Информация о том, откуда пришел пользователь, сохраняется в state
- После авторизации пользователь возвращается на исходную страницу

### Обработка ошибок
- При ошибках авторизации пользователь перенаправляется на логин
- При ошибках выхода из системы токены очищаются принудительно

## Производительность

### Ленивая загрузка
- Компоненты загружаются только при необходимости
- AuthLoader показывается только во время проверки авторизации

### Кэширование состояния
- Состояние авторизации кэшируется в контексте
- Избегаются повторные проверки токенов

## Отладка

### Проверка состояния авторизации
```javascript
import { useAuthContext } from '../features/auth/model/AuthContext';

const DebugComponent = () => {
  const { isAuthenticated, user, loading } = useAuthContext();
  
  console.log('Auth state:', { isAuthenticated, user, loading });
  
  return null;
};
```

### Проверка токенов
```javascript
import tokenService from '../entities/user/tokenService';

console.log('Access token valid:', tokenService.isAccessTokenValid());
console.log('Refresh token valid:', tokenService.isRefreshTokenValid());
```

## Лучшие практики

1. **Всегда используйте ProtectedRoute для защищенных страниц**
2. **Используйте PublicRoute для страниц авторизации**
3. **Проверяйте состояние авторизации в компонентах**
4. **Обрабатывайте ошибки авторизации**
5. **Используйте AuthLoader для лучшего UX** 